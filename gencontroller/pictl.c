/*
 * pictl.c
 *
 *  Created on: 10 de set de 2022
 *      Author: marco
 */

//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "pictl.h"

#include "pid.h"
//=============================================================================

//=============================================================================
/*--------------------------------- Globals ---------------------------------*/
//=============================================================================
pid_t pid;
//=============================================================================

//=============================================================================
/*-------------------------------- Functions --------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void pictlInitialize(void){

	pidInitialize(&pid, 0);
}
//-----------------------------------------------------------------------------
int32_t pictlSetParams(void *params, int32_t n){

	uint32_t *p = (uint32_t *)params;

	pidConfig_t pidparams;

	pidparams.a1 = *((float *)(&p[0]));
	pidparams.a2 = *((float *)(&p[1]));
	pidparams.b0 = *((float *)(&p[2]));
	pidparams.b1 = *((float *)(&p[3]));
	pidparams.b2 = *((float *)(&p[4]));

	pidparams.saturate = *((uint32_t *)(&p[5]));
	pidparams.umax = *((float *)(&p[6]));
	pidparams.umin = *((float *)(&p[7]));

	pidSetParams(&pid, &pidparams);

	return 0;
}
//-----------------------------------------------------------------------------
int32_t pictlGetParams(void *in, void *out){

	int32_t n;
	uint32_t *p;
	uint32_t *pout = (uint32_t *)out;
	pidConfig_t params;

	pidGetParams(&pid, &params);

	n = sizeof(params);
	p = (uint32_t *)&params;
	while(n--){
		*pout++ = *p++;
	}

	return 0;
}
//-----------------------------------------------------------------------------
int32_t pictlRun(void *inputs, int32_t ninputs, void *meas, int32_t nmeas, void *outputs){

	float r, y, e, u;

	r = *((float *)inputs);
	y = *((float *)meas);
	e = r - y;

	u = pidRun(&pid, e);

	*((float *)outputs) = u;

	return 1;
}
//-----------------------------------------------------------------------------
//=============================================================================
