/*
 * @file ipcClientZynq.c
 *
 * @brief Client for the inter-processor communication (IPC) library.
 */

#ifdef SOC_CPU1
//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "ipcServerZynq.h"

/* Device and drivers */
#include "xparameters.h"
#include "xil_types.h"

#include "xil_exception.h"
#include "xscugic_hw.h"
#include "xil_printf.h"
#include "xstatus.h"
#include "xscugic.h"

/* LRS SoC defs */
#include "soc_defs.h"

#include "ipcServer.h"
//=============================================================================

//=============================================================================
/*-------------------------------- Prototypes -------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void ipcServerZynqIrq(void *callbackRef);
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*------------------------------- Definitions -------------------------------*/
//=============================================================================
/*
 * Software generated interrupt (SIG) from CPU0 to CPU1. This interrupt is
 * generated by CPU0 to notify CPU1 that a new command is to be executed.
 */
#define IPC_SERVER_ZYNQ_INT_CPU0_TO_CPU1			SOC_SIG_CPU0_TO_CPU1

/*
 * Software generated interrupt (SIG) from CPU1 to CPU0. This interrupt is
 * generated by CPU1 to notify CPU0 that a requested command was executed.
 */
#define IPC_SERVER_ZYNQ_INT_CPU1_TO_CPU0			SOC_SIG_CPU1_TO_CPU0


/**/
#define IPC_SERVER_ZYNQ_CONFIG_SIG_CPU0_ID			SOC_SIG_CPU0_ID


typedef struct{

	/* Interrupt controller instance */
	XScuGic *intcInstance;


}ipcServerZynqControl_t;
//=============================================================================

//=============================================================================
/*--------------------------------- Globals ---------------------------------*/
//=============================================================================
ipcServerZynqControl_t xipcServerZynqControl;
//=============================================================================

//=============================================================================
/*-------------------------------- Functions --------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void ipcServerZynqInitialize(void *irqInst){

	xipcServerZynqControl.intcInstance = (XScuGic *)irqInst;

	XScuGic_Connect(xipcServerZynqControl.intcInstance, IPC_SERVER_ZYNQ_INT_CPU0_TO_CPU1,
					(Xil_ExceptionHandler)ipcServerZynqIrq,
					(void  *)xipcServerZynqControl.intcInstance);
	XScuGic_Enable(xipcServerZynqControl.intcInstance, IPC_SERVER_ZYNQ_INT_CPU0_TO_CPU1);
}
//-----------------------------------------------------------------------------
int32_t ipcServerZynqIrqSend(void){

	XScuGic_SoftwareIntr ( xipcServerZynqControl.intcInstance ,
			IPC_SERVER_ZYNQ_INT_CPU1_TO_CPU0 , IPC_SERVER_ZYNQ_CONFIG_SIG_CPU0_ID ) ;

	return 0;
}
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*----------------------------- Static functions ----------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*----------------------------------- IRQ -----------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void ipcServerZynqIrq(void *callbackRef){

	ipcServerRequest();
}
//-----------------------------------------------------------------------------
//=============================================================================
#endif /* SOC_CPU1 */
